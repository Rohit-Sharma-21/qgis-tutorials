<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Locating Nearest Facility with Origin-Destination Matrix (QGIS3) &mdash; QGIS Tutorials and Tips</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootswatch-3.2.0/united/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="QGIS Tutorials and Tips" href="../../index.html" />
    <link rel="next" title="Service Area Analysis using Openrouteservice (QGIS3)" href="service_area_analysis.html" />
    <link rel="prev" title="Basic Network Visualization and Routing (QGIS3)" href="basic_network_analysis.html" />

<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B1WQ7B80XJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-B1WQ7B80XJ');
</script>


  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><img src="../../_static/logo.png">
          QGIS Tutorials and Tips</a>
        <span class="navbar-text navbar-version pull-left"><b>v1.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Tutorials List <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="making_a_map.html">Making a Map (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="working_with_attributes.html">Working with Attributes (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="importing_spreadsheets_csv.html">Importing Spreadsheets or CSV files (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_vector_styling.html">Basic Vector Styling (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="calculating_line_lengths.html">Calculating Line Lengths and Statistics (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="raster_styling_and_analysis.html">Basic Raster Styling and Analysis (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="raster_mosaicing_and_clipping.html">Raster Mosaicing and Clipping (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_terrain.html">Working with Terrain Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_wms.html">Working with WMS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../working_with_projections.html">Working with Projections</a></li>
<li class="toctree-l1"><a class="reference internal" href="georeferencing_basics.html">Georeferencing Topo Sheets and Scanned Maps (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_georeferencing.html">Géoréférencer des images aériennes (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../digitizing_basics.html">Digitizing Map Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="performing_table_joins.html">Performing Table Joins (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="performing_spatial_joins.html">Performing Spatial Joins (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="creating_heatmaps.html">Creating Heatmaps (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="animating_time_series.html">Animating Time Series Data (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="handling_invalid_geometries.html">Handling Invalid Geometries (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="performing_spatial_queries.html">Performing Spatial Queries (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="nearest_neighbor_analysis.html">Nearest Neighbor Analysis (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="sampling_raster_data.html">Sampling Raster Data using Points or Polygons (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interpolating_point_data.html">Interpolating Point Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch_processing.html">Traitement par lots en utilisant le framework de traitement (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_graphical_modeler.html">Automating Complex Workflows using Processing Modeler (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="automating_map_creation.html">Création automatisée de cartes avec l&#8217;Atlas de l&#8217;outil de mise en page (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_criteria_overlay.html">Multi Criteria Overlay Analysis (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_network_analysis.html">Basic Network Visualization and Routing (QGIS3)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Locating Nearest Facility with Origin-Destination Matrix (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="service_area_analysis.html">Service Area Analysis using Openrouteservice (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_qgis_browser.html">Using the QGIS Browser</a></li>
<li class="toctree-l1"><a class="reference internal" href="../open_bil_bip_bsq_files.html">Open BIL, BIP or BSQ files in QGIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started_with_pyqgis.html">Getting Started With Python Programming (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_algorithms_pyqgis.html">Running Processing Algorithms via Python (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_a_python_plugin.html">Building a Python Plugin (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_python_plugin.html">Building a Processing Plugin (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_python_functions.html">Using Custom Python Expression Functions (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing_python_scripts.html">Écrire des scripts Python pour la structure de traitement (QGIS3)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running_qgis_jobs.html">Running and Scheduling QGIS Processing Jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performing_table_joins_pyqgis.html">Performing Table Joins (PyQGIS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../web_mapping_with_qgis2web.html">Web Mapping with QGIS2Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="../creating_basemaps_with_qtiles.html">Créer des fonds de carte avec QTiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_plugins.html">Using Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../downloading_osm_data.html">Searching and Downloading OpenStreetMap Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../learning_resources.html">Ressources pour l&#8217;apprentissage de QGIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Crédits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../batch_processing.html">Batch Processing using Processing Framework (QGIS2)</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="basic_network_analysis.html" title="Previous Chapter: Basic Network Visualization and Routing (QGIS3)"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Basic Network...</span>
    </a>
  </li>
  <li>
    <a href="service_area_analysis.html" title="Next Chapter: Service Area Analysis using Openrouteservice (QGIS3)"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Service Area ... &raquo;</span>
    </a>
  </li>
              
            
            

            

            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><h4>Author</h4>
<p>Ujaval Gandhi</p>
<a href="https://twitter.com/intent/follow?screen_name=spatialthoughts" class="twitter-follow-button" data-show-count="false">Follow @spatialthoughts</a>
<hr>
<p>I have several full-length QGIS courses that are now completely free for self-study. 
Check out the <a href="https://courses.spatialthoughts.com/" target="_blank">Course Materials</a>.</p>

<hr>
<!-- EmailOctopus Form -->

<link rel="stylesheet"
      href="https://emailoctopus.com/bundles/emailoctopuslist/css/1.6/form.css"
>
<div class="emailoctopus-form-wrapper emailoctopus-form-default null"
     style="font-family: Arial, &quot;Helvetica Neue&quot;, Helvetica, sans-serif; color: rgb(26, 26, 26);"
>
  <h2 class="emailoctopus-heading">
    Subscribe to my list
  </h2>
  <p class="emailoctopus-success-message">
  </p>
  <p class="emailoctopus-error-message">
  </p>
  <form action="https://emailoctopus.com/lists/7325d131-1dbb-11eb-a3d0-06b4694bee2a/members/embedded/1.3s/add"
        method="post"
        data-message-success="Thanks for subscribing!"
        data-message-missing-email-address="Your email address is required."
        data-message-invalid-email-address="Your email address looks incorrect, please try again."
        data-message-bot-submission-error="This doesn't look like a human submission."
        data-message-consent-required="Please check the checkbox to indicate your consent."
        data-message-invalid-parameters-error="This form has missing or invalid fields."
        data-message-unknown-error="Sorry, an unknown error has occurred. Please try again later."
        class="emailoctopus-form"
        data-sitekey="6LdYsmsUAAAAAPXVTt-ovRsPIJ_IVhvYBBhGvRV6"
  >
    <div class="emailoctopus-form-row">
      <label for="field_0">
        Email address
      </label>
      <input id="field_0"
             name="field_0"
             type="email"
             placeholder
             required="required"
      >
    </div>
    <div aria-hidden="true"
         class="emailoctopus-form-row-hp"
    >
      <input type="text"
             name="hpc4b27b6e-eb38-11e9-be00-06b4694bee2a"
             tabindex="-1"
             autocomplete="nope"
      >
    </div>
    <div class="emailoctopus-form-row-subscribe">
      <input type="hidden"
             name="successRedirectUrl"
      >
      <button type="submit"
              style="background-color: rgb(224, 224, 224); color: rgb(0, 0, 0); font-family: inherit;"
      >
        Subscribe
      </button>
    </div>
  </form>
</div>
<script src="https://emailoctopus.com/bundles/emailoctopuslist/js/1.6/form-recaptcha.js">
</script>
<script src="https://emailoctopus.com/bundles/emailoctopuslist/js/1.6/form-embed.js">
</script>

<hr>


<h4>Change Language</h4>
<form role="form" class="sidebar-form sidebar-left">
<select id="languages" class="form-control select-mini">
  <option value="en">English</option>
  <option value="zh_TW">Chinese (Taiwan)</option>
  <option value="nl">Dutch</option>
  <option value="fi_FI">Finnish</option>
  <option value="fr">French</option>
  <option value="de">German</option>
  <option value="el">Greek</option>
  <option value="id">Indonesian</option>
  <option value="it">Italian</option>
  <option value="ko">Korean</option>
  <option value="pt_BR">Portuguese</option>
  <option value="ro">Romanian</option>
  <option value="ru">Russian</option>
  <option value="sl">Slovenian</option>
  <option value="es">Spanish</option>
  <option value="th">Thai</option>
  <option value="tr">Turkish</option>
  <option value="uk">Ukrainian</option>
  <option value="vi">Vietnamese</option>
</select>
</form>
        </div>
      </div>
    <div class="col-md-9">
      

  <div class="section" id="locating-nearest-facility-with-origin-destination-matrix-qgis3">
<h1>Locating Nearest Facility with Origin-Destination Matrix (QGIS3)<a class="headerlink" href="#locating-nearest-facility-with-origin-destination-matrix-qgis3" title="Lien permanent vers ce titre">¶</a></h1>
<p>In the previous tutorial, <a class="reference internal" href="basic_network_analysis.html"><em>Basic Network Visualization and Routing (QGIS3)</em></a>, we learnt how to build a network and calculate the shortest path between 2 points. We can apply that technique for many different types of network-based analysis. One such application is to compute <strong>Origin-Destination Matrix</strong> or <strong>OD Matrix</strong>. Given a set of origin points and another set of destination points, we can calculate shortest path between each origin-destination pairs and find out the travel distance/time between them. Such analysis is useful to locate the closest facility to any given point. For example, a logistics company may use this analysis to find the closest warehouse to their customers to optimize delivery routes. Here we use Distance Matrix algorithm from <strong>QGIS Network Analysis Toolbox (QNEAT3)</strong> plugin to find the nearest health facility to each address in the city.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This tutorial shows how to use your own network data to compute an origin-destination matrix. If you do not have your own network data, you can use <strong>ORS Tools Plugin</strong> and algorithm <span class="menuselection">ORS Tools ‣ Matrix ‣  Matrix from Layers</span> to do the similar analysis using OpenStreetMap data. See <a class="reference internal" href="service_area_analysis.html"><em>Service Area Analysis using Openrouteservice (QGIS3)</em></a> to learn how to use ORS Tools plugin.</p>
</div>
<div class="section" id="overview-of-the-task">
<h2>Overview of the task<a class="headerlink" href="#overview-of-the-task" title="Lien permanent vers ce titre">¶</a></h2>
<p>We will take 2 layers for Washington DC - one with points representing addresses and another with points representing mental health facilities - and find out the facility with the least travel distance from each address.</p>
<div class="section" id="other-skills-you-will-learn">
<h3>Other skills you will learn<a class="headerlink" href="#other-skills-you-will-learn" title="Lien permanent vers ce titre">¶</a></h3>
<ul class="simple">
<li>Extract a stratified random sample from a point layer.</li>
<li>Use Virtual Layers to run SQL query on a QGIS layer.</li>
<li>Use Python Console Editor to run a pyqgis script.</li>
</ul>
</div>
</div>
<div class="section" id="get-the-data">
<h2>Get the data<a class="headerlink" href="#get-the-data" title="Lien permanent vers ce titre">¶</a></h2>
<p>District of Columbia government freely shares hundreds of datasets on the <a class="reference external" href="https://opendata.dc.gov/">Open Data Catalog</a>.</p>
<p>Download the following data layers as shapefiles.</p>
<ul class="simple">
<li><a class="reference external" href="https://opendata.dc.gov/datasets/street-centerlines">Street Centerlines</a></li>
<li><a class="reference external" href="https://opendata.dc.gov/datasets/address-points">Address Points</a></li>
<li><a class="reference external" href="https://opendata.dc.gov/datasets/adult-mental-health-providers">Adult Mental Health Providers</a></li>
</ul>
<p>For convenience, you may directly download a copy of the datasets from the
links below:</p>
<p><a class="reference external" href="http://www.qgistutorials.com/downloads/Street_Centerlines.zip">Street_Centerlines.zip</a></p>
<p><a class="reference external" href="http://www.qgistutorials.com/downloads/Address_Points.zip">Address_Points.zip</a></p>
<p><a class="reference external" href="http://www.qgistutorials.com/downloads/Adult_Mental_Health_Providers.zip">Adult_Mental_Health_Providers.zip</a></p>
<p>Data Source: <a class="reference internal" href="../credits.html#dcopendata" id="id1">[DCOPENDATA]</a></p>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Lien permanent vers ce titre">¶</a></h2>
<p>Visit <span class="menuselection">Plugins ‣ Manage and Install plugins</span>. Search for <strong>QNEAT3</strong> plugin and install it. Click <span class="guilabel">Close</span>.</p>
<img alt="../../_images/setup12.png" class="align-center" src="../../_images/setup12.png" />
</div>
<div class="section" id="procedure">
<h2>Procedure<a class="headerlink" href="#procedure" title="Lien permanent vers ce titre">¶</a></h2>
<ol class="arabic simple">
<li>Locate the downloaded <code class="docutils literal"><span class="pre">Street_Centerlines.zip</span></code> file in the <span class="guilabel">Browser</span> panel. Expand it and drag the <code class="docutils literal"><span class="pre">Street_Centerlines.shp</span></code> file to the canvas. Similarly, locate the <code class="docutils literal"><span class="pre">Adult_Mental_Health_Providers.zip</span></code> file, expand it and add <code class="docutils literal"><span class="pre">Adult_Mental_Health_Providers.shp</span></code> to the canvas.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1101.png" class="align-center" src="../../_images/1101.png" />
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Next, locate the <code class="docutils literal"><span class="pre">Address_Points.zip</span></code> file, expand it and add the <code class="docutils literal"><span class="pre">Address_Points.shp</span></code>. You will see a lot of points around the city. Each point represents a valid address. We will not randomly select 1 point in each ward to use as the origin points. This technique is called stratified sampling. Go to <span class="menuselection">Processing ‣ Toolbox</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/247.png" class="align-center" src="../../_images/247.png" />
</div></blockquote>
<ol class="arabic simple" start="3">
<li>Search for and locate the <span class="menuselection">Vector Selection ‣ Random extract within subsets</span> algorithm.</li>
</ol>
<blockquote>
<div><img alt="../../_images/332.png" class="align-center" src="../../_images/332.png" />
</div></blockquote>
<ol class="arabic simple" start="4">
<li>Select <code class="docutils literal"><span class="pre">Address_Points</span></code> as the <span class="guilabel">Input layer</span>. Each address point contains an attribute called <code class="docutils literal"><span class="pre">WARD_2012</span></code> which has the ward number associated with the address. As we want only 1 point per ward, we use that attribute as the <span class="guilabel">ID field</span>. Set <span class="guilabel">Number/percentage of selected features</span> as <code class="docutils literal"><span class="pre">1</span></code>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/417.png" class="align-center" src="../../_images/417.png" />
</div></blockquote>
<ol class="arabic simple" start="5">
<li>A new layer <code class="docutils literal"><span class="pre">Extracted</span> <span class="pre">(random</span> <span class="pre">stratified)</span></code> will be added to the <span class="guilabel">Layers</span> panel.</li>
</ol>
<blockquote>
<div><img alt="../../_images/517.png" class="align-center" src="../../_images/517.png" />
</div></blockquote>
<ol class="arabic simple" start="6">
<li>Turn-off the visibility for the <code class="docutils literal"><span class="pre">Address_Points</span></code> layer. Right-click on the <code class="docutils literal"><span class="pre">Extracted</span> <span class="pre">(random</span> <span class="pre">stratified)</span></code> layer and select <span class="guilabel">Rename layer</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/617.png" class="align-center" src="../../_images/617.png" />
</div></blockquote>
<ol class="arabic simple" start="7">
<li>Let&#8217;s rename this layer as <code class="docutils literal"><span class="pre">origin_points</span></code>. Similarly rename the <code class="docutils literal"><span class="pre">Adult_Mental_Health_Providers</span></code> layers representing the health facilities as <code class="docutils literal"><span class="pre">destination_points</span></code>. Naming the layers this way makes it easy to identify them in subsequent processing. Go to <span class="menuselection">Processing ‣ Toolbox</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/716.png" class="align-center" src="../../_images/716.png" />
</div></blockquote>
<ol class="arabic simple" start="8">
<li>Locate the <span class="menuselection">QNEAT3 ‣ Distance matrices ‣ OD Matrix from Layers as Table (m:n)</span> algorithm. If you do not see this algorithm in the toolbox, make sure you have installed the <strong>QNEAT3</strong> plugin.</li>
</ol>
<blockquote>
<div><img alt="../../_images/816.png" class="align-center" src="../../_images/816.png" />
</div></blockquote>
<ol class="arabic simple" start="9">
<li>This algorithm helps find the distances along the network between selected origin and destination layers. Select <code class="docutils literal"><span class="pre">Street_Centerlines</span></code> as the <span class="guilabel">Network layer</span>. Select <code class="docutils literal"><span class="pre">origin_points</span></code> as the <span class="guilabel">From-Points layer</span> and <code class="docutils literal"><span class="pre">OBJECTID</span></code> as the <span class="guilabel">Unique Point ID field</span>. Similarly, set <code class="docutils literal"><span class="pre">destination_points</span></code> as the <span class="guilabel">To-Points Layer</span> and <code class="docutils literal"><span class="pre">OBJECTID</span></code> as  the <span class="guilabel">Unique Point ID field</span>. Set the <span class="guilabel">Optimization Criterion</span> as <code class="docutils literal"><span class="pre">Shortest</span> <span class="pre">Path</span></code>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/916.png" class="align-center" src="../../_images/916.png" />
</div></blockquote>
<ol class="arabic simple" start="10">
<li>As many streets in the network are one-way, we need to set the <span class="guilabel">Advanced parameters</span> to specify the direction. See <a class="reference internal" href="basic_network_analysis.html"><em>Basic Network Visualization and Routing (QGIS3)</em></a> for more details on how these attributes are structured. Choose <code class="docutils literal"><span class="pre">DIRECTIONA</span></code> as the <span class="guilabel">Direction field</span>. Enter <code class="docutils literal"><span class="pre">One</span> <span class="pre">Way</span> <span class="pre">(Digitizing</span> <span class="pre">direction)</span></code> as the <span class="guilabel">Value for forward direction</span> and <code class="docutils literal"><span class="pre">One</span> <span class="pre">way</span> <span class="pre">(Against</span> <span class="pre">digitizing</span> <span class="pre">direction)</span></code> as the <span class="guilabel">Value for backward direction</span>. Keep other options to their default values and click <span class="guilabel">Run</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1016.png" class="align-center" src="../../_images/1016.png" />
</div></blockquote>
<ol class="arabic simple" start="11">
<li>A new table layer called <code class="docutils literal"><span class="pre">Output</span> <span class="pre">OD</span> <span class="pre">Matrix</span></code> will be added to the <span class="guilabel">Layers</span> panel. Right-click and select <span class="guilabel">Open Attributes Table</span>. You will see that the table contains <em>117</em> rows. We had 9 origin points and 13 destination points - so the output contains <em>9x13 = 117</em> pairs of origins and destination. The <code class="docutils literal"><span class="pre">total_cost</span></code> column contains distance in meters between each origin point to every destination point.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1119.png" class="align-center" src="../../_images/1119.png" />
</div></blockquote>
<ol class="arabic simple" start="12">
<li>For this tutorial, we are interested in only the destination point with the shortest distance. We can create a SQL query to pick the destination with the least <code class="docutils literal"><span class="pre">total_cost</span></code> among all destinations. Go to <span class="menuselection">Database ‣ DB Manager..</span></li>
</ol>
<blockquote>
<div><img alt="../../_images/1217.png" class="align-center" src="../../_images/1217.png" />
</div></blockquote>
<ol class="arabic simple" start="13">
<li>In the <span class="guilabel">DB Manager</span> dialog, select the <span class="menuselection">Virtual Layers ‣ Project layers ‣ Output OD Matrix</span> from the left-hand panel. See <a class="reference external" href="https://docs.qgis.org/testing/en/docs/user_manual/working_with_vector/virtual_layers.html">Virtual layers</a> documentation to learn more. Click the <span class="guilabel">SQL Window</span> button.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1316.png" class="align-center" src="../../_images/1316.png" />
</div></blockquote>
<ol class="arabic simple" start="14">
<li>Enter the following query and click <span class="guilabel">Execute</span>. The results will be displayed in the panel below. As expected, we have 9 rows in the result - the shortest path destination for each origin point. Check and select <span class="guilabel">Column with unique values</span> as <code class="docutils literal"><span class="pre">origin_id</span></code>. Enter <code class="docutils literal"><span class="pre">nearest_destinations</span></code> as the <span class="guilabel">Layer name (prefix)</span>. Click <span class="guilabel">Load</span>.</li>
</ol>
<blockquote>
<div><div class="highlight-none"><div class="highlight"><pre><span></span>select origin_id, destination_id, min(total_cost) as shortest_distance
from &#39;Output OD Matrix&#39; group by origin_id
</pre></div>
</div>
<img alt="../../_images/1415.png" class="align-center" src="../../_images/1415.png" />
</div></blockquote>
<ol class="arabic simple" start="15">
<li>A new virtual layer <code class="docutils literal"><span class="pre">nearest_destinations</span></code> will be added to the <span class="guilabel">Layers</span> panel. This table has the result of our analysis. Nearest mental health center for each of the 9 origin points. Let&#8217;s try a few different ways to visualize and validate these results. Go to <span class="menuselection">Processing ‣ Toolbox</span>. Search for and locate the <span class="menuselection">Join attributes by field value</span> algorithm. Double-click to launch it.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1514.png" class="align-center" src="../../_images/1514.png" />
</div></blockquote>
<ol class="arabic simple" start="16">
<li>Select <code class="docutils literal"><span class="pre">origin_points</span></code> as the <span class="guilabel">Input layer</span> and <code class="docutils literal"><span class="pre">OBJECTID</span></code> as the <span class="guilabel">Table field</span>. Set <code class="docutils literal"><span class="pre">nearest_destinations</span></code> as the <span class="guilabel">Input layer 2</span> and <code class="docutils literal"><span class="pre">origin_id</span></code> as the <span class="guilabel">Table field 2</span>. Click the <span class="guilabel">...</span> button next to <span class="guilabel">Layer 2 fields to copy</span> and select <code class="docutils literal"><span class="pre">destination_id</span></code> and <code class="docutils literal"><span class="pre">shortest_distance</span></code>. Click <span class="guilabel">Run</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1613.png" class="align-center" src="../../_images/1613.png" />
</div></blockquote>
<ol class="arabic simple" start="17">
<li>A new <code class="docutils literal"><span class="pre">Joined</span> <span class="pre">layer</span></code> will be added to the <span class="guilabel">Layers</span> panel. This layer has the nearest destination id attribute for each origin point. We can now create a hub-spoke visualization using this layer. Search for <span class="menuselection">Vector analysis ‣ Join by lines (hub lines)</span> algorithm. Right-click to launch it.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1714.png" class="align-center" src="../../_images/1714.png" />
</div></blockquote>
<ol class="arabic simple" start="18">
<li>Select <code class="docutils literal"><span class="pre">destination_points</span></code> as the <span class="guilabel">Hub layer</span> and <code class="docutils literal"><span class="pre">OBJECTID</span></code> as the <span class="guilabel">Hub ID field</span>. Select <code class="docutils literal"><span class="pre">Joined</span> <span class="pre">layer`</span> <span class="pre">as</span> <span class="pre">the</span> <span class="pre">:guilabel:`Spoke</span> <span class="pre">layer`</span> <span class="pre">and</span> <span class="pre">``destination_id</span></code> as the <span class="guilabel">Spoke ID field</span>. Click <span class="guilabel">Run</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1813.png" class="align-center" src="../../_images/1813.png" />
</div></blockquote>
<ol class="arabic simple" start="19">
<li>Once the processing finishes, a new layer <code class="docutils literal"><span class="pre">Hub</span> <span class="pre">lines</span></code> will be added to the <span class="guilabel">Layers</span> panel. This layer shows the lines connecting each origin with the nearest destination.</li>
</ol>
<blockquote>
<div><img alt="../../_images/1911.png" class="align-center" src="../../_images/1911.png" />
</div></blockquote>
<ol class="arabic simple" start="20">
<li>Note that even though the lines connecting the origin and destination is a straight-line, the destination was found using the distance along the network. It will be much useful visualization to show the actual shortest-path between each origin-destination. As of now, there is no easy way to generate the shortest-path between multiple origin-destination pairs the way we generated the distance matrix. But I will demonstrate a way to use some python scripting to generate this visualization. Firs, let&#8217;s run the shortest path algorithm on 1 pair. Locate the <span class="menuselection">QNEAT3 ‣ Routing ‣ Shortest path (point to point)</span> algorithm and launch it.</li>
</ol>
<blockquote>
<div><img alt="../../_images/209.png" class="align-center" src="../../_images/209.png" />
</div></blockquote>
<ol class="arabic simple" start="21">
<li>In the <span class="guilabel">Shortest Path (Point to Point)</span> dialog, select <code class="docutils literal"><span class="pre">Street_Centerlines</span></code> as the <span class="guilabel">Vector layer representing network</span>.  Keep the <span class="guilabel">Path type to calculate</span> as <code class="docutils literal"><span class="pre">Shortest</span></code>. Next we need to pick a start and end point. You can click the <span class="guilabel">...</span> button next to <span class="guilabel">Start point</span> and click on the origin point in the canvas. Similarly select the destination point as the <span class="guilabel">End point</span>. Expand the <span class="guilabel">Advanced parameter</span> section. Choose <code class="docutils literal"><span class="pre">DIRECTIONA</span></code> as the <span class="guilabel">Direction field</span>. Enter <code class="docutils literal"><span class="pre">One</span> <span class="pre">Way</span> <span class="pre">(Digitizing</span> <span class="pre">direction)</span></code> as the <span class="guilabel">Value for forward direction</span> and <code class="docutils literal"><span class="pre">One</span> <span class="pre">way</span> <span class="pre">(Against</span> <span class="pre">digitizing</span> <span class="pre">direction)</span></code> as the <span class="guilabel">Value for backward direction</span>. Keep other options to their default values and click <span class="guilabel">Run</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/2114.png" class="align-center" src="../../_images/2114.png" />
</div></blockquote>
<ol class="arabic simple" start="22">
<li>A new layer <code class="docutils literal"><span class="pre">Shortest</span> <span class="pre">Path</span> <span class="pre">Layer</span></code> wll be added to the <span class="guilabel">Layers</span> panel. You will see that this path follows the network rather than connecting the origin and destination with a straight line. The reason we ran the algorithm on 1 pair is to easily identify the parameter values that we can use in our script. Select both <code class="docutils literal"><span class="pre">Hub</span> <span class="pre">lines</span></code> and <code class="docutils literal"><span class="pre">Shortest</span> <span class="pre">Path</span> <span class="pre">layer</span></code>, right-click and select <span class="guilabel">Remove Layer</span>. Click the <span class="guilabel">History</span> button in the <span class="guilabel">Processing Toolbox</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/2212.png" class="align-center" src="../../_images/2212.png" />
</div></blockquote>
<ol class="arabic simple" start="23">
<li>Pick the top-most algorithm and you will see the full command displayed in the panel below. Copy the command and click <span class="guilabel">Close</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/2311.png" class="align-center" src="../../_images/2311.png" />
</div></blockquote>
<ol class="arabic simple" start="24">
<li>Go to <span class="menuselection">Plugins ‣ Python Console</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/248.png" class="align-center" src="../../_images/248.png" />
</div></blockquote>
<ol class="arabic simple" start="25">
<li>Click the <span class="guilabel">Show Editor</span> button in the <span class="guilabel">Python Console</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/256.png" class="align-center" src="../../_images/256.png" />
</div></blockquote>
<ol class="arabic simple" start="26">
<li>In the editor window, copy/paste the following script. This script uses the parameter values from the processing history that we saw earlier. Click <span class="guilabel">Run Script</span> button to start execution.</li>
</ol>
<blockquote>
<div><img alt="../../_images/266.png" class="align-center" src="../../_images/266.png" />
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">origin_layer</span> <span class="o">=</span>  <span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">mapLayersByName</span><span class="p">(</span><span class="s1">&#39;origin_points&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">destination_layer</span> <span class="o">=</span>  <span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">mapLayersByName</span><span class="p">(</span><span class="s1">&#39;destination_points&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">matrix</span> <span class="o">=</span>  <span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">mapLayersByName</span><span class="p">(</span><span class="s1">&#39;nearest_destinations&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">matrix</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">():</span>
    <span class="n">origin_expr</span> <span class="o">=</span> <span class="n">QgsExpression</span><span class="p">(</span><span class="s1">&#39;OBJECTID={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;origin_id&#39;</span><span class="p">]))</span>
    <span class="n">destination_expr</span> <span class="o">=</span> <span class="n">QgsExpression</span><span class="p">(</span><span class="s1">&#39;OBJECTID={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;destination_id&#39;</span><span class="p">]))</span>
    <span class="n">origin_feature</span> <span class="o">=</span> <span class="n">origin_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">(</span><span class="n">origin_expr</span><span class="p">))</span>
    <span class="n">origin_coords</span> <span class="o">=</span>  <span class="p">[(</span><span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">origin_feature</span><span class="p">]</span>
    <span class="n">destination_feature</span> <span class="o">=</span> <span class="n">destination_layer</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">(</span><span class="n">QgsFeatureRequest</span><span class="p">(</span><span class="n">destination_expr</span><span class="p">))</span>
    <span class="n">destination_coords</span> <span class="o">=</span>  <span class="p">[(</span><span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span><span class="o">.</span><span class="n">y</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">destination_feature</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;INPUT&#39;</span><span class="p">:</span><span class="s1">&#39;Street_Centerlines&#39;</span><span class="p">,</span>
        <span class="s1">&#39;START_POINT&#39;</span><span class="p">:</span><span class="s1">&#39;{},{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">origin_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s1">&#39;END_POINT&#39;</span><span class="p">:</span><span class="s1">&#39;{},{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">destination_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">destination_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
        <span class="s1">&#39;STRATEGY&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ENTRY_COST_CALCULATION_METHOD&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;DIRECTION_FIELD&#39;</span><span class="p">:</span><span class="s1">&#39;DIRECTIONA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;VALUE_FORWARD&#39;</span><span class="p">:</span><span class="s1">&#39;One Way (Digitizing direction)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;VALUE_BACKWARD&#39;</span><span class="p">:</span><span class="s1">&#39;One way (Against digitizing direction)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;VALUE_BOTH&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DEFAULT_DIRECTION&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;SPEED_FIELD&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
        <span class="s1">&#39;DEFAULT_SPEED&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;TOLERANCE&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;OUTPUT&#39;</span><span class="p">:</span><span class="s1">&#39;memory:&#39;</span><span class="p">}</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Executing analysis&#39;</span><span class="p">)</span>
    <span class="n">processing</span><span class="o">.</span><span class="n">runAndLoadResults</span><span class="p">(</span><span class="s2">&quot;qneat3:shortestpathpointtopoint&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="27">
<li>The script will take a few minutes to run. Once finished, you will see 9 new layers named <code class="docutils literal"><span class="pre">Shortest</span> <span class="pre">Path</span> <span class="pre">layer</span></code>. Let&#8217;s merge these paths to a single layer. Find the <span class="menuselection">Vector general ‣ Merge vector layers</span> algorithm and launch it.</li>
</ol>
<blockquote>
<div><img alt="../../_images/276.png" class="align-center" src="../../_images/276.png" />
</div></blockquote>
<ol class="arabic simple" start="28">
<li>Select all 9 <code class="docutils literal"><span class="pre">Shortest</span> <span class="pre">Path</span> <span class="pre">layer</span></code> as the <span class="guilabel">Input layers</span>. Click <span class="guilabel">Run</span>.</li>
</ol>
<blockquote>
<div><img alt="../../_images/286.png" class="align-center" src="../../_images/286.png" />
</div></blockquote>
<ol class="arabic simple" start="29">
<li>A new <code class="docutils literal"><span class="pre">Merged</span></code> layer will be created which will contain shortest path between our origins and destinations.</li>
</ol>
<blockquote>
<div><img alt="../../_images/295.png" class="align-center" src="../../_images/295.png" />
</div></blockquote>
</div>
</div>





  <div id="disqus_thread"></div>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    </div>
      
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Ujaval Gandhi.<br/>
      Mis à jour le Nov 03, 2020.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.6.<br/>
    </p>
  </div>
</footer>
<div class="container">
  <p>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US">Creative Commons Attribution 4.0 International License</a></p>
</div>
<!-- Twitter Button -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<!-- Disqus comments widget -->
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'qgistutorials'; // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

<script type="text/javascript">
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<!-- Script fpr language switching. Largely adapted from https://github.com/pcav/faunalia-website -->
<script>
    var currentPage = 'docs/3/origin_destination_matrix.html'; // coming from sphinx, always without starting '/'
    var currentLang = 'en';
    $(document).ready(function(){

        var search = new RegExp('\/[a-zA-Z_]{2,8}\/'+ currentPage, 'gi');
        var langPlusPage = window.location.href.match(search);
        // it's possible this is a index.html page called without 'index.html', try without the currentPage
        if (langPlusPage==undefined){
            search = new RegExp('\/[a-zA-Z_]{2,8}\/$', 'gi');
            langPlusPage = window.location.href.match(search);
        }

        // it's possible this is an index.html page called without 'index.html', try removing index.html
        if (langPlusPage==undefined){
            currentPage = currentPage.replace('index.html','')
            search = new RegExp('\/[a-zA-Z_]{2,8}\/'+ currentPage, 'gi');
            langPlusPage = window.location.href.match(search);
        }
        // still no langPlugPage: stop, because the language swicher will misbehave 

        if (langPlusPage == undefined || langPlusPage.length != 1){
            alert('You hit an error, please report back to us.');
            return;
        }
        langPlusPage = langPlusPage[0];
        currentLang = langPlusPage.replace(currentPage, '');

        $("#languages").val(currentLang.replace(/\//g,'')); // currentLang is something like '/nl/'

        $("#languages").change(function() {
            gotoLang($(this).val());
        });

    });

    // load current page in a different language
    function gotoLang(lang){
        var currentUrl = window.location.href;
        var newUrl = currentUrl.replace(currentLang, '/'+lang+'/');
        window.location.href = newUrl;
    }
</script>

  </body>
</html>